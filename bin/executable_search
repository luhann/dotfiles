#!/usr/bin/env fish

# Define search menu entries
set menu_text "Default: google
!gh: github
!rd: rdocumentation
!r: reddit
!yt: youtube
!t: twitch
!sp: spotify
!ddg: duckduckgo
!w: wikipedia"

# URL encode function
function url_encode
    string replace -a ' ' '+' -- $argv | string replace -a '&' '%26' | string replace -a '?' '%3F' | string replace -a '=' '%3D' | string replace -a '#' '%23'
end

# Choose menu program based on session type
if test "$XDG_SESSION_TYPE" != 'wayland'
    if command -v rofi >/dev/null
        set selection (echo $menu_text | rofi -dmenu -p "search:" -mesg "search options")
    else
        echo "Error: rofi not found" >&2
        exit 1
    end
else
    if command -v fuzzel >/dev/null
        # Use regular dmenu mode, not prompt-only
        set selection (echo $menu_text | fuzzel --dmenu --prompt "search:")
    else
        echo "Error: fuzzel not found" >&2
        exit 1
    end
end

# Exit if no selection
if test -z "$selection"
    exit 0
end

# Handle different selection formats
# Check if it's a menu item selection (contains colon)
if string match -q '*:*' $selection
    # Extract just the bang command from "!cmd: description"
    set bang_part (string split ':' $selection)[1]
    set first_word (string trim $bang_part)
    set has_search_terms 0
    set search_terms ""
else
    # It's typed input, parse normally
    set parts (string split ' ' $selection --max 2)
    set first_word $parts[1]
    set has_search_terms 0
    set search_terms ""
    if test (count $parts) -gt 1
        # Get everything after the first word (including multiple words)
        set search_terms (string replace -r "^$first_word " "" $selection)
        set has_search_terms 1
    end
end

# Process the command
if string match -q '!*' $first_word
    # This is a bang command
    set bang_cmd (string sub -s 2 $first_word)  # Remove the ! prefix
    
    # Set up URLs based on the bang command
    switch $bang_cmd
        case "gh"
            set search_url "https://github.com/search?q="
            set home_url "https://github.com"
        case "rd"
            set search_url "https://www.rdocumentation.org/search?q="
            set home_url "https://www.rdocumentation.org"
        case "r"
            set search_url "https://reddit.com/search?q="
            set home_url "https://reddit.com"
        case "yt"
            set search_url "https://www.youtube.com/results?search_query="
            set home_url "https://www.youtube.com"
        case "t"
            set search_url "https://twitch.tv/search?term="
            set home_url "https://twitch.tv"
        case "sp"
            set search_url "https://open.spotify.com/search/"
            set home_url "https://open.spotify.com"
        case "ddg"
            set search_url "https://duckduckgo.com/?q="
            set home_url "https://duckduckgo.com"
        case "w"
            set search_url "https://www.wikipedia.org/wiki/"
            set home_url "https://www.wikipedia.org"
        case "*"
            set search_url "https://www.google.com/search?q="
            set home_url "https://www.google.com"
    end
    
    if test $has_search_terms -eq 1
        # Search term provided
        set encoded_search (url_encode $search_terms)
        xdg-open $search_url$encoded_search
    else
        # Just the bang command, open the homepage
        xdg-open $home_url
    end
else
    # No bang command, search Google for the entire input
    # Handle "Default: google" selection
    if string match -q "Default:*" $selection
        set search_text (string replace -r '^Default:\s*' '' $selection)
        if test -n "$search_text"
            set encoded_search (url_encode $search_text)
        else
            # Just "Default: google" selected, go to Google homepage
            xdg-open "https://www.google.com"
            exit 0
        end
    else
        set encoded_search (url_encode $selection)
    end
    xdg-open "https://www.google.com/search?q=$encoded_search"
end